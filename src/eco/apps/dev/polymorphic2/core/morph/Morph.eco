
{
    isa std Classlike;

    Instance :: Clonable
    {
        |
            boundsInfo,
            kernel,
            paper,

            node
        |

        {
            protected polymorphic <- $package;

            initWithKernel: k BoundsInfo: bi Paper: p => (
                (std io out << 'Creating a new morph: ' << (k name)) newline commit.

                kernel     <- k.
                boundsInfo <- bi.
                paper      <- p.
                node       <- (((polymorphic core morph) tree nodes) MorphNode) Morph: self.

                paper node: node. "Set the paper's node to a MorphNode pointing to us..."

              ^ self
            );

            initWithKernel: kernel BoundsInfo: boundsInfo => initWithKernel: kernel BoundsInfo: boundsInfo Paper: ((polymorphic core paper Paper) New);

            name => kernel name;

            bounds => boundsInfo translatedBounds;
            origin => bounds origin;

            iAmDirty => (
                world yes: [ :w | w iAmDirty: self ].
              ^ self
            );

            protected executeChanged => (
                (std io out << 'I changed: ' << kernel name) newline commit.
                world yes: [ :w | w iHaveChanged: self ].
              ^ self
            );

            kernelChangeCallback => (
                executeChanged.
              ^ self
            );

            changed => (
                kernel changed.
              ^ self
            );

            aChildChanged => (
                executeChanged.
              ^ self
            );

            kernelDisposeCallback => (
                "TODO"
              ^ self
            );

            changeBounds: newBounds => (
                (((newBounds extent) equalsPoint: (bounds extent)) not) if: [
                    paper clearAndReset.
                    paper resize: (newBounds extent).
                    iAmDirty.
                ].
                boundsInfo <- newBounds.
              ^ self
            );

            protected enterWorld: world => (
                world addMorph: self.
                kernel addMorph: self.
                iAmDirty.
              ^ self
            );

            protected exitWorld: world => (
                kernel removeMorph: self.
                world removeMorph: self.
              ^ self
            );

            connectToParentNode: parentNode => (
                node reparent: parentNode.
                world yes: [ :w | enterWorld: w ].
              ^ self
            );

            disconnectFromParentNode => (
                paper destroy. "Destroy the paper, so that all children are purged."
                world yes: [ :w | exitWorld: w ].
                node disconnect.
              ^ self
            );

            enable => (
              ^ self
            );

            disable => (
              ^ self
            );

            parent      => node parent;
            parentMorph => parent yes: [ :p | p maybeMorph ];

            world => node world;

            childrenDo: block => (
                paper morphsDo: block.
              ^ self
            );

            protected internalRedraw => (
                (std io out << 'Redrawing: ' << kernel name) newline commit.
                kernel drawOnStream: (paper stream) Instance: self.
              ^ self
            );

            redrawInPlace => (
                paper clear.
                internalRedraw.
              ^ self
            );
            redrawFreely => (
                | b <- paper realBounds |
                
                paper clear.
                internalRedraw.

                "If the size of the paper has changed, we need to forward the change to the parent presentation."
                (((paper realBounds) equalsRectangle: b) not) -> [
                    parentMorph yes: [ :p |
                        p aChildChanged.
                    ].
                ].
              ^ self
            );

            renderAtOffset: offset On: renderer => (
                renderer withPushedRelativeOffset: offset Do: [
                    paper renderOn: renderer.
                ].
              ^ self
            );

            tick => (
                ((kernel behavior) animated?) -> [ kernel changed ].
              ^ self
            );
            
            writeOn: w => w << name;
        }
    };

    Kernel: kernel BoundsInfo: bounds Paper: paper => (Instance clone) initWithKernel: kernel BoundsInfo: bounds Paper: paper;
    Kernel: kernel BoundsInfo: bounds              => (Instance clone) initWithKernel: kernel BoundsInfo: bounds;
}
